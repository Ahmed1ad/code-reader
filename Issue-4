<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Fast Lock Ultimate</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{box-shadow:0 0 25px #00ff88;transition:.2s;}
.scan-success{border-color:#22ff22!important;box-shadow:0 0 40px #22ff22!important;}
.scan-detect{border-color:#ffee00!important;}
</style>
</head>

<body class="bg-black text-white text-center min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-2">‚ö° Fast Lock Ultimate</h1>

<div class="relative w-full max-w-md">
  <video id="camera" class="w-full rounded-2xl shadow-2xl" autoplay playsinline muted></video>

  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div id="scanBox" class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>
</div>

<p id="status" class="mt-3 text-emerald-400">‚è≥ Starting...</p>
<p id="detectedCode" class="mt-2 text-yellow-400 font-bold text-lg">‚Äî</p>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video=camera;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=status;
const scanBox=document.getElementById("scanBox");
const detectedCodeEl=document.getElementById("detectedCode");

let worker=null;
let busy=false;
let dialing=false;
let streamRef=null;
let lastCode="";

// ===== OffscreenCanvas =====
let offCanvas=null,offCtx=null;
if(typeof OffscreenCanvas!=="undefined"){
  offCanvas=new OffscreenCanvas(320,160);
  offCtx=offCanvas.getContext("2d");
}

// üß† ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖÿ±ŸÜ
function extractUSSDSmart(text){

  if(!text) return null;

  text=text.replace(/[Oo]/g,"0").replace(/[lI]/g,"1");

  let normal=text.match(/\*858\*(\d{12,16})#/);
  if(normal) return normal[1];

  let reversed=text.match(/#(\d{12,16})\*858\*/);
  if(reversed) return reversed[1];

  let digits=text.replace(/[^\d]/g,"");
  if(/^\d{12,16}$/.test(digits)){
    return digits;
  }

  return null;
}

// üì≥
const vibrate=()=>navigator.vibrate?.(200);

// üîÅ ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿßÿ≥ÿ≠
function resetScanner(){
  setTimeout(()=>{
    dialing=false;
    scanBox.classList.remove("scan-success");
    statusText.innerText="‚úÖ Ready for next scan";
  },2500); // ‚è±Ô∏è ÿ®ÿπÿØ 2.5 ÿ´ÿßŸÜŸäÿ©
}

// üìû ÿßÿ™ÿµÿßŸÑ
function dialUSSD(code){

  if(dialing) return;

  // üö´ ŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ŸÜŸÅÿ≥ ÿßŸÑŸÉŸàÿØ ŸÅŸàÿ±Ÿãÿß
  if(code===lastCode) return;
  lastCode=code;

  dialing=true;

  scanBox.classList.add("scan-success");
  vibrate();
  statusText.innerText="üìû "+code;

  // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
  setTimeout(()=>{
    window.location.href="tel:"+encodeURIComponent(code);
  },150);

  // üî• ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
  resetScanner();
}

// ===== Worker =====
async function initWorker(){
  worker=await Tesseract.createWorker({logger:()=>{}});
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
  await worker.setParameters({
    tessedit_char_whitelist:"0123456789*#"
  });
}

// ===== Camera =====
async function startCamera(){
  try{
    streamRef=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });

    video.srcObject=streamRef;
    statusText.innerText="‚úÖ Camera Ready";
    scanLoop();

  }catch(e){
    statusText.innerText="‚ùå Camera Ÿäÿ≠ÿ™ÿßÿ¨ HTTPS";
    console.error(e);
  }
}

// ===== pulse =====
function pulse(){
  scanBox.classList.add("scan-detect");
  setTimeout(()=>scanBox.classList.remove("scan-detect"),80);
}

// ===== Loop =====
async function scanLoop(){

  if(video.readyState===4 && !busy){

    busy=true;

    const w=video.videoWidth;
    const h=video.videoHeight;

    const cw=w*0.6;
    const ch=h*0.25;
    const cx=(w-cw)/2;
    const cy=(h-ch)/2;

    const target=offCanvas||canvas;
    const tctx=offCanvas?offCtx:ctx;

    target.width=cw;
    target.height=ch;
    tctx.drawImage(video,cx,cy,cw,ch,0,0,cw,ch);

    try{
      const {data}=await worker.recognize(target);

      if(data.text.trim()) pulse();

      const raw=extractUSSDSmart(data.text);

      if(raw){
        const ussd=`*858*${raw}#`;
        detectedCodeEl.innerText=ussd;
        dialUSSD(ussd);
      }

      busy=false;

    }catch(e){
      busy=false;
    }
  }

  requestAnimationFrame(scanLoop);
}

// ===== Start =====
(async()=>{
  statusText.innerText="‚öôÔ∏è Booting...";
  await initWorker();
  await startCamera();
})();
</script>
</body>
</html>