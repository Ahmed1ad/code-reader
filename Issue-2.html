<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>LEGEND MODE</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{
  box-shadow:0 0 25px #00ff88;
  transition:.18s;
}
.scan-detect{ border-color:#ffee00!important; }
.scan-success{ border-color:#22ff22!important; box-shadow:0 0 50px #22ff22!important; }
.debug{
  position:fixed;bottom:10px;left:10px;
  background:#000a;padding:8px 12px;
  font-size:12px;border-radius:8px;
}
</style>
</head>

<body class="bg-black text-white text-center min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-2">üßø LEGEND MODE</h1>

<div class="relative w-full max-w-md">
  <video id="camera" class="w-full rounded-2xl shadow-2xl" autoplay playsinline muted></video>
  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div id="scanBox" class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>
</div>

<p id="status" class="mt-3 text-emerald-400">‚è≥ Loading...</p>

<div id="debug" class="debug text-left">
FPS: --<br>
Confidence: --<br>
Worker: --
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video=camera;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=status;
const scanBox=document.getElementById("scanBox");
const debugBox=document.getElementById("debug");

let workers=[];
let busy=false;
let dialing=false;
let streamRef=null;
let lastTime=performance.now();
let fps=0;

const WORKERS=2;
const CONF=48;

// ===== OffscreenCanvas =====
let offCanvas=null,offCtx=null;
if(typeof OffscreenCanvas!=="undefined"){
  offCanvas=new OffscreenCanvas(320,160);
  offCtx=offCanvas.getContext("2d");
}

// ===== Utils =====
const rev=s=>s.split("").reverse().join("");

function extractUSSDSmart(text){
  if(!text) return null;

  // ŸÖÿ®ÿßÿ¥ÿ±
  let m=text.match(/\*858\*(\d{12,16})#/);
  if(m) return `*858*${m[1]}#`;

  // ŸÖÿπŸÉŸàÿ≥
  let r=rev(text).match(/\*858\*(\d{12,16})#/);
  if(r) return `*858*${r[1]}#`;

  // ÿ™ŸÜÿ∏ŸäŸÅ
  text=text.replace(/[Oo]/g,"0").replace(/[lI]/g,"1");

  let digits=text.replace(/[^\d]/g,"");

  // ŸÅŸÑÿ™ÿ± ÿ∂Ÿàÿ∂ÿßÿ°
  if(/(\d)\1{6,}/.test(digits)) return null;

  if(/^\d{12,16}$/.test(digits))
    return `*858*${digits}#`;

  let rd=rev(digits);
  if(/^\d{12,16}$/.test(rd))
    return `*858*${rd}#`;

  return null;
}

// ===== ÿßÿ™ÿµÿßŸÑ =====
function dialUSSD(code){
  if(dialing) return;
  dialing=true;

  scanBox.classList.add("scan-success");
  navigator.vibrate?.(200);
  statusText.innerText="üìû "+code;

  streamRef?.getTracks().forEach(t=>t.stop());

  setTimeout(()=>location.href="tel:"+encodeURIComponent(code),200);
}

// ===== Workers =====
async function initWorkers(){
  for(let i=0;i<WORKERS;i++){
    const w=await Tesseract.createWorker({logger:()=>{}});
    await w.loadLanguage("eng");
    await w.initialize("eng");
    workers.push(w);
  }
}

// ===== Camera =====
async function startCamera(){
  try{
    streamRef=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},audio:false
    });
    video.srcObject=streamRef;
    statusText.innerText="‚úÖ Ready";
    scanLoop();
  }catch(e){
    statusText.innerText="‚ùå HTTPS required";
  }
}

// ===== Visual pulse =====
function pulse(){
  scanBox.classList.add("scan-detect");
  setTimeout(()=>scanBox.classList.remove("scan-detect"),90);
}

// ===== Main Loop =====
async function scanLoop(){

  // FPS ÿ≠ÿ≥ÿßÿ®
  const now=performance.now();
  fps=Math.round(1000/(now-lastTime));
  lastTime=now;

  if(!dialing && video.readyState===4 && !busy){

    busy=true;

    const w=video.videoWidth;
    const h=video.videoHeight;

    const cw=w*0.6;
    const ch=h*0.25;
    const cx=(w-cw)/2;
    const cy=(h-ch)/2;

    const target=offCanvas||canvas;
    const tctx=offCanvas?offCtx:ctx;

    target.width=cw;
    target.height=ch;
    tctx.drawImage(video,cx,cy,cw,ch,0,0,cw,ch);

    try{
      const workerIndex=Math.floor(Math.random()*workers.length);
      const {data}=await workers[workerIndex].recognize(target);

      if(data.text.trim()) pulse();

      const ussd=extractUSSDSmart(data.text);

      // Debug
      debugBox.innerHTML=
        "FPS: "+fps+"<br>"+
        "Confidence: "+data.confidence.toFixed(1)+"<br>"+
        "Worker: "+workerIndex;

      if(!ussd && data.confidence<CONF){
        busy=false;
      }else{
        if(ussd) dialUSSD(ussd);
        busy=false;
      }

    }catch(e){
      busy=false;
    }
  }

  requestAnimationFrame(scanLoop);
}

// ===== Start =====
(async()=>{
  statusText.innerText="‚öôÔ∏è Booting Legend...";
  await initWorkers();
  await startCamera();
})();
</script>
</body>
</html>