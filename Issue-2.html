<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>USSD Beast Scanner</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{
  box-shadow: 0 0 25px #00ff88;
}
</style>
</head>

<body class="bg-black text-white text-center min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-4">ğŸ“·.V2 ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯</h1>

<div class="relative w-full max-w-md">

  <video id="camera"
    class="w-full rounded-2xl shadow-2xl"
    autoplay playsinline muted></video>

  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>

</div>

<p id="status" class="mt-4 text-lg text-emerald-400">
â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
</p>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

let worker = null;
let scanning = false;
let busy = false;
let dialing = false;
let streamRef = null;

const CONFIDENCE_THRESHOLD = 60; // ğŸ”¥ ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡Ø§

// ğŸ§  Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠ Ø¢Ù…Ù†
function extractUSSDSmart(text){

  if(!text) return null;

  // âœ… 1. Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
  const direct = text.match(/\*858\*(\d{13,16})#/);
  if(direct){
    return `*858*${direct[1]}#`;
  }

  // ğŸ§¹ ØªØµØ­ÙŠØ­ OCR
  text = text
    .replace(/[Oo]/g, "0")
    .replace(/[lI]/g, "1");

  const lines = text.split(/\n|\r/);

  // âœ… 2. Ø±Ù‚Ù… Ù…Ù†ÙØ±Ø¯
  for(let line of lines){
    let digitsOnly = line.replace(/[^\d]/g, "");
    if(/^\d{13,16}$/.test(digitsOnly)){
      return `*858*${digitsOnly}#`;
    }
  }

  return null;
}

// ğŸ“³ Ø§Ù‡ØªØ²Ø§Ø²
function vibrate(){
  if(navigator.vibrate) navigator.vibrate(200);
}

// ğŸ“ Ø§ØªØµØ§Ù„ Ø¢Ù…Ù†
function dialUSSD(code){
  if(dialing) return;
  dialing = true;

  vibrate();
  statusText.innerText = "ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + code;

  if(streamRef){
    streamRef.getTracks().forEach(track => track.stop());
  }

  setTimeout(()=>{
    window.location.href = "tel:" + encodeURIComponent(code);
  }, 300);
}

// ğŸš€ Worker
async function initWorker(){
  worker = await Tesseract.createWorker({ logger: () => {} });
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
}

// ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function startCamera(){
  try{
    streamRef = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" },
      audio:false
    });

    video.srcObject = streamRef;
    statusText.innerText = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©";
    startScanning();

  }catch(e){
    statusText.innerText = "âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” ØªØ£ÙƒØ¯ Ù…Ù† HTTPS";
  }
}

// ğŸ”¥ Ù…Ø³Ø­ Ø³Ø±ÙŠØ¹ Ù…Ø¹ ÙÙ„ØªØ± Ø§Ù„Ø«Ù‚Ø©
function startScanning(){
  if(scanning) return;
  scanning = true;

  setInterval(async ()=>{
    if(busy || dialing) return;
    if(video.readyState !== 4) return;

    busy = true;

    const w = video.videoWidth;
    const h = video.videoHeight;

    const cropW = w * 0.6;
    const cropH = h * 0.25;
    const cropX = (w - cropW)/2;
    const cropY = (h - cropH)/2;

    canvas.width = cropW;
    canvas.height = cropH;

    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

    try{
      const { data } = await worker.recognize(canvas);

      // ğŸ”¥ ÙÙ„ØªØ± Ø§Ù„Ø«Ù‚Ø©
      if(data.confidence < CONFIDENCE_THRESHOLD){
        busy = false;
        return;
      }

      const ussd = extractUSSDSmart(data.text);

      if(ussd && !dialing){
        dialUSSD(ussd);
      }

    }catch(e){}

    busy = false;

  }, 700);
}

// ğŸš€ Ø¨Ø¯Ø¡
(async ()=>{
  statusText.innerText = "âš™ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ...";
  await initWorker();
  await startCamera();
})();
</script>

</body>
</html>
