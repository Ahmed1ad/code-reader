<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Vodafone Smart Scanner V2</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{
  box-shadow: 0 0 25px #00ff88;
}
</style>
</head>

<body class="bg-black text-white min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-4 text-center">
ğŸ“· ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ ÙƒØ§Ø±Øª ÙÙˆØ¯Ø§ÙÙˆÙ†
</h1>

<!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
<div class="relative w-full max-w-md">

  <video id="camera"
    class="w-full rounded-2xl shadow-2xl"
    autoplay playsinline muted></video>

  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>

</div>

<p id="status" class="mt-4 text-lg text-emerald-400">
â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
</p>

<!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
<div class="w-full max-w-md mt-6">
  <h2 class="text-xl font-bold mb-2">ğŸ“‹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h2>
  <div id="results" class="space-y-3"></div>
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");
const resultsDiv = document.getElementById("results");

let worker = null;
let scanning = false;
let busy = false;
let streamRef = null;
let detectedSet = new Set();

// ğŸ§  Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø¬Ø¯Ù‹Ø§
function extractUSSDSmart(text){

  if(!text) return [];

  // ØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ OCR
  text = text
    .replace(/[Oo]/g, "0")
    .replace(/[lI]/g, "1");

  const results = [];
  const lines = text.split(/\n|\r/);

  for(let line of lines){

    let cleanLine = line.replace(/\s/g, "");

    // âœ… 1. ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø¬Ù…Ù„Ø©
    const embedded = cleanLine.match(/\*858\*(\d{13,16})#/);
    if(embedded){
      const code = embedded[1];
      results.push(`*858*${code}#`);
      continue;
    }

    // âœ… 2. Ø±Ù‚Ù… ÙÙ‚Ø·
    const numberOnly = cleanLine
      .replace(/[^\d]/g, "")
      .match(/^(\d{13,16})$/);

    if(numberOnly){
      const code = numberOnly[1];
      results.push(`*858*${code}#`);
      continue;
    }
  }

  return results;
}

// â• Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©
function addResult(code){

  if(detectedSet.has(code)) return;
  detectedSet.add(code);

  const item = document.createElement("div");
  item.className = "bg-gray-900 p-4 rounded-xl flex items-center justify-between gap-2";

  item.innerHTML = `
    <span class="text-sm break-all">${code}</span>
    <button class="bg-emerald-500 px-4 py-2 rounded-lg font-bold">
      Ø§ØªØµØ§Ù„
    </button>
  `;

  const btn = item.querySelector("button");
  btn.onclick = () => {
    window.location.href = "tel:" + encodeURIComponent(code);
  };

  resultsDiv.prepend(item);
}

// ğŸš€ Worker
async function initWorker(){
  worker = await Tesseract.createWorker({ logger: () => {} });
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
}

// ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function startCamera(){
  try{
    streamRef = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" },
      audio:false
    });

    video.srcObject = streamRef;
    statusText.innerText = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©";
    startScanning();

  }catch(e){
    statusText.innerText = "âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” ØªØ£ÙƒØ¯ Ù…Ù† HTTPS";
  }
}

// ğŸ”¥ Ù…Ø³Ø­ Ù…Ø³ØªÙ…Ø±
function startScanning(){
  if(scanning) return;
  scanning = true;

  setInterval(async ()=>{
    if(busy) return;
    if(video.readyState !== 4) return;

    busy = true;

    const w = video.videoWidth;
    const h = video.videoHeight;

    const cropW = w * 0.6;
    const cropH = h * 0.25;
    const cropX = (w - cropW)/2;
    const cropY = (h - cropH)/2;

    canvas.width = cropW;
    canvas.height = cropH;

    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

    try{
      const { data:{ text } } = await worker.recognize(canvas);
      const codes = extractUSSDSmart(text);
      codes.forEach(code => addResult(code));
    }catch(e){}

    busy = false;

  }, 900);
}

// ğŸš€ Ø¨Ø¯Ø¡
(async ()=>{
  statusText.innerText = "âš™ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ...";
  await initWorker();
  await startCamera();
})();
</script>

</body>
</html>
