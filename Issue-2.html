<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>USSD Turbo Scanner</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{ box-shadow:0 0 25px #00ff88; }
</style>
</head>

<body class="bg-black text-white text-center min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-4">âš¡ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹</h1>

<div class="relative w-full max-w-md">
  <video id="camera"
    class="w-full rounded-2xl shadow-2xl"
    autoplay playsinline muted></video>

  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>
</div>

<p id="status" class="mt-4 text-lg text-emerald-400">
â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
</p>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

let worker=null;
let scanning=false;
let busy=false;
let dialing=false;
let streamRef=null;

const CONFIDENCE_THRESHOLD = 55;

// ğŸš€ OffscreenCanvas (Ø£Ø³Ø±Ø¹ Ù„Ùˆ Ù…Ø¯Ø¹ÙˆÙ…)
let offCanvas=null;
let offCtx=null;
if(typeof OffscreenCanvas!=="undefined"){
  offCanvas=new OffscreenCanvas(300,150);
  offCtx=offCanvas.getContext("2d");
}

// ğŸ§  Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠ
function extractUSSDSmart(text){

  if(!text) return null;

  // Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹
  const direct=text.match(/\*858\*(\d{13,16})#/);
  if(direct) return `*858*${direct[1]}#`;

  // ØªØµØ­ÙŠØ­ OCR
  text=text.replace(/[Oo]/g,"0").replace(/[lI]/g,"1");

  const lines=text.split(/\n|\r/);

  for(let line of lines){
    let digits=line.replace(/[^\d]/g,"");
    if(/^\d{13,16}$/.test(digits)){
      return `*858*${digits}#`;
    }
  }

  return null;
}

// ğŸ“³ Ø§Ù‡ØªØ²Ø§Ø²
function vibrate(){
  if(navigator.vibrate) navigator.vibrate(200);
}

// ğŸ“ Ø§ØªØµØ§Ù„
function dialUSSD(code){
  if(dialing) return;
  dialing=true;

  vibrate();
  statusText.innerText="ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: "+code;

  if(streamRef){
    streamRef.getTracks().forEach(t=>t.stop());
  }

  setTimeout(()=>{
    window.location.href="tel:"+encodeURIComponent(code);
  },300);
}

// ğŸš€ Worker
async function initWorker(){
  worker=await Tesseract.createWorker({logger:()=>{}});
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
}

// ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§
async function startCamera(){
  try{
    streamRef=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });

    video.srcObject=streamRef;
    statusText.innerText="âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©";
    startScanning();

  }catch(e){
    statusText.innerText="âŒ ØªØ£ÙƒØ¯ Ù…Ù† HTTPS";
  }
}

// âš¡ Ù…Ø³Ø­ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹
function startScanning(){
  if(scanning) return;
  scanning=true;

  setInterval(async()=>{
    if(busy||dialing) return;
    if(video.readyState!==4) return;

    busy=true;

    const w=video.videoWidth;
    const h=video.videoHeight;

    const cropW=w*0.6;
    const cropH=h*0.25;
    const cropX=(w-cropW)/2;
    const cropY=(h-cropH)/2;

    // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ø§Ù… OffscreenCanvas Ù„Ùˆ Ù…ØªØ§Ø­
    if(offCanvas){
      offCanvas.width=cropW;
      offCanvas.height=cropH;
      offCtx.drawImage(video,cropX,cropY,cropW,cropH,0,0,cropW,cropH);
    }else{
      canvas.width=cropW;
      canvas.height=cropH;
      ctx.drawImage(video,cropX,cropY,cropW,cropH,0,0,cropW,cropH);
    }

    try{
      const {data}=await worker.recognize(offCanvas||canvas);

      const ussd=extractUSSDSmart(data.text);

      // ğŸ§  ÙÙ„ØªØ± Ø°ÙƒÙŠ
      if(!ussd && data.confidence<CONFIDENCE_THRESHOLD){
        busy=false;
        return;
      }

      if(ussd && !dialing){
        dialUSSD(ussd);
      }

    }catch(e){}

    busy=false;

  },450); // âš¡ Ø£Ø³Ø±Ø¹
}

// ğŸš€ Ø¨Ø¯Ø¡
(async()=>{
  statusText.innerText="âš™ï¸ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ...";
  await initWorker();
  await startCamera();
})();
</script>
</body>
</html>