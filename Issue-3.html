<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Precision Legend</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
.scan-box{
  box-shadow:0 0 25px #00ff88;
  transition:.2s;
}
.scan-success{
  border-color:#22ff22!important;
  box-shadow:0 0 45px #22ff22!important;
}
.scan-detect{
  border-color:#ffee00!important;
}
.debug{
  position:fixed;
  bottom:10px;
  left:10px;
  background:#000a;
  padding:8px 12px;
  font-size:12px;
  border-radius:8px;
}
</style>
</head>

<body class="bg-black text-white text-center min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-2">üëë Precision Legend</h1>

<div class="relative w-full max-w-md">
  <video id="camera" class="w-full rounded-2xl shadow-2xl" autoplay playsinline muted></video>

  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div id="scanBox" class="w-64 h-28 border-4 border-emerald-400 rounded-xl scan-box"></div>
  </div>
</div>

<p id="status" class="mt-3 text-emerald-400">‚è≥ Loading...</p>

<!-- ‚≠ê ÿπÿ±ÿ∂ ÿßŸÑŸÉŸàÿØ -->
<p id="detectedCode" class="mt-2 text-yellow-400 font-bold text-lg">‚Äî</p>

<div id="debug" class="debug text-left">
FPS: --<br>
Confidence: --
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
const video=camera;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=status;
const scanBox=document.getElementById("scanBox");
const debugBox=document.getElementById("debug");
const detectedCodeEl=document.getElementById("detectedCode");

let worker=null;
let busy=false;
let dialing=false;
let streamRef=null;
let lastTime=performance.now();
let fps=0;

const CONF=48;

// ===== OffscreenCanvas =====
let offCanvas=null,offCtx=null;
if(typeof OffscreenCanvas!=="undefined"){
  offCanvas=new OffscreenCanvas(320,160);
  offCtx=offCanvas.getContext("2d");
}

// üß† ÿπŸÉÿ≥
const rev=s=>s.split("").reverse().join("");

// üß† ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ∞ŸÉŸä ŸÖÿ∂ÿ®Ÿàÿ∑
function extractUSSDSmart(text){

  if(!text) return null;

  // ÿ™ÿµÿ≠Ÿäÿ≠ OCR
  text=text.replace(/[Oo]/g,"0").replace(/[lI]/g,"1");

  // ===== ŸÉŸàÿØ ŸÖÿ®ÿßÿ¥ÿ± =====
  const direct=text.match(/\*858\*(\d{13})#/);
  if(direct) return direct[1];

  const lines=text.split(/\n|\r/);

  for(let line of lines){

    let digits=line.replace(/[^\d]/g,"");

    // ‚≠ê ŸÅŸÑÿ™ÿ± ÿ∞ŸÉŸä (Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 8)
    if(/^8\d{12}$/.test(digits)){
      return digits;
    }

    // ŸÖÿπŸÉŸàÿ≥
    const r=rev(digits);
    if(/^8\d{12}$/.test(r)){
      return r;
    }
  }

  return null;
}

// üì≥ ÿßŸáÿ™ÿ≤ÿßÿ≤
const vibrate=()=>navigator.vibrate?.(200);

// üìû ÿßÿ™ÿµÿßŸÑ (ÿ®ÿØŸàŸÜ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß)
function dialUSSD(code){
  if(dialing) return;
  dialing=true;

  scanBox.classList.add("scan-success");
  vibrate();
  statusText.innerText="üìû "+code;

  setTimeout(()=>{
    window.location.href="tel:"+encodeURIComponent(code);
  },200);
}

// ===== Worker =====
async function initWorker(){
  worker=await Tesseract.createWorker({logger:()=>{}});
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
}

// ===== Camera =====
async function startCamera(){
  try{
    streamRef=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });

    video.srcObject=streamRef;
    statusText.innerText="‚úÖ Ready";
    scanLoop();

  }catch(e){
    statusText.innerText="‚ùå HTTPS required";
  }
}

// üéØ pulse
function pulse(){
  scanBox.classList.add("scan-detect");
  setTimeout(()=>scanBox.classList.remove("scan-detect"),90);
}

// ===== Main Loop =====
async function scanLoop(){

  const now=performance.now();
  fps=Math.round(1000/(now-lastTime));
  lastTime=now;

  if(!dialing && video.readyState===4 && !busy){

    busy=true;

    const w=video.videoWidth;
    const h=video.videoHeight;

    const cw=w*0.6;
    const ch=h*0.25;
    const cx=(w-cw)/2;
    const cy=(h-ch)/2;

    const target=offCanvas||canvas;
    const tctx=offCanvas?offCtx:ctx;

    target.width=cw;
    target.height=ch;
    tctx.drawImage(video,cx,cy,cw,ch,0,0,cw,ch);

    try{
      const {data}=await worker.recognize(target);

      if(data.text.trim()) pulse();

      debugBox.innerHTML=
        "FPS: "+fps+"<br>"+
        "Confidence: "+data.confidence.toFixed(1);

      const rawCode=extractUSSDSmart(data.text);

      // ‚≠ê ÿπÿ±ÿ∂ ÿßŸÑŸÉŸàÿØ
      if(rawCode){
        const ussd=`*858*${rawCode}#`;
        detectedCodeEl.innerText=ussd;

        if(!dialing){
          dialUSSD(ussd);
        }
      }

      busy=false;

    }catch(e){
      busy=false;
    }
  }

  requestAnimationFrame(scanLoop);
}

// ===== Start =====
(async()=>{
  statusText.innerText="‚öôÔ∏è Booting...";
  await initWorker();
  await startCamera();
})();
</script>
</body>
</html>
